<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvancedPF - Personal Finance Dashboard</title>

    <!-- Tailwind CSS CDN (shows console warning in dev - safe to ignore for local use) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js Plugins (must load before Alpine.js) -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Chart.js Datalabels Plugin (for pie chart labels) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- Papa Parse (CSV parsing) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Configuration and Data -->
    <script src="js/config.js"></script>
    <script src="js/dataLoader.js"></script>
    <script src="js/dataProcessing.js"></script>

    <!-- Themes -->
    <script src="js/themes.js"></script>

    <!-- Charts (each chart in separate file for token efficiency) -->
    <script src="js/chart-netWorthAllTime.js"></script>
    <script src="js/chart-netWorth12Months.js"></script>
    <script src="js/chart-assetAllocation.js"></script>
</head>
<body>
    <!-- Alpine.js App -->
    <div x-data="dashboard()"
         x-init="init()"
         :style="`background-color: ${backgroundColor}; color: ${textColor}; min-height: 100vh;`"
         class="transition-colors duration-300">

        <!-- Top Right Icons -->
        <div class="fixed top-6 right-6 flex items-center gap-3 z-40">
            <!-- GitHub Link -->
            <a href="https://github.com/erikmlutz/advancedpf"
               target="_blank"
               rel="noopener noreferrer"
               :style="`color: ${textColor};`"
               class="p-3 hover:opacity-70 transition-opacity duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </a>

            <!-- Settings Button (Pines Pattern) -->
            <button @click="settingsOpen = true"
                    :style="`color: ${textColor};`"
                    class="p-3 hover:opacity-70 transition-opacity duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <!-- Settings Modal (Pines Full-Screen Modal) -->
        <template x-teleport="body">
            <div x-show="settingsOpen"
                 @keydown.escape.window="settingsOpen = false"
                 x-trap.inert.noscroll="settingsOpen"
                 class="fixed inset-0 z-50 overflow-y-auto"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 :style="`background-color: ${backgroundColor}; color: ${textColor};`"
                 x-cloak>

                <!-- Modal Content -->
                <div class="relative w-full min-h-screen px-8 py-8">

                    <!-- Close Button -->
                    <button @click="settingsOpen = false"
                            :style="`color: ${textColor};`"
                            class="fixed top-6 right-6 flex justify-center items-center w-10 h-10 hover:opacity-70 transition-opacity duration-200 z-10">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <!-- Modal Header -->
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-4xl font-light mb-8">Settings</h2>

                        <!-- Settings Tabs -->
                        <div x-data="{ activeTab: 'general' }">
                            <!-- Tab Navigation -->
                            <div class="flex gap-4 border-b mb-8"
                                 :style="`border-color: ${theme.classified.backgroundAlt};`">
                                <button @click="activeTab = 'general'"
                                        :style="activeTab === 'general' ? `color: ${theme.classified.text}; border-color: ${theme.classified.accent};` : `color: ${theme.classified.textSubtle};`"
                                        :class="activeTab === 'general' ? 'border-b-2' : ''"
                                        class="pb-3 px-2 text-lg font-light transition-colors">
                                    General
                                </button>
                                <button @click="activeTab = 'theme'"
                                        :style="activeTab === 'theme' ? `color: ${theme.classified.text}; border-color: ${theme.classified.accent};` : `color: ${theme.classified.textSubtle};`"
                                        :class="activeTab === 'theme' ? 'border-b-2' : ''"
                                        class="pb-3 px-2 text-lg font-light transition-colors">
                                    Theme
                                </button>
                            </div>

                            <!-- Tab Content -->
                            <div class="space-y-8">
                                <!-- General Tab -->
                                <div x-show="activeTab === 'general'">
                                    <div class="space-y-4">
                                        <!-- Verbose Mode Toggle -->
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-light">Verbose Mode</div>
                                                <div class="text-sm opacity-70">Show detailed tooltips with source breakdowns</div>
                                            </div>
                                            <button @click="verbose = !verbose; renderCharts()"
                                                    :style="`background-color: ${verbose ? theme.classified.accent : theme.classified.backgroundAlt};`"
                                                    class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                                <span :class="verbose ? 'translate-x-6' : 'translate-x-1'"
                                                      :style="`background-color: ${theme.classified.background};`"
                                                      class="inline-block h-4 w-4 transform rounded-full transition-transform">
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Theme Tab -->
                                <div x-show="activeTab === 'theme'">
                        <!-- Theme Selector (Pines Dropdown - Adapted) -->

                            <div x-data="{ themeDropdownOpen: false }" class="relative">
                                <!-- Dropdown Button -->
                                <button @click="themeDropdownOpen = !themeDropdownOpen"
                                        :style="`border-color: ${theme.classified.backgroundAlt};`"
                                        class="w-full flex items-center justify-between px-4 py-3 border transition-opacity hover:opacity-70">
                                    <!-- Theme name (left) -->
                                    <span class="font-light" x-text="theme.name"></span>

                                    <div class="flex items-center gap-3">
                                        <!-- Current theme colors preview (right) -->
                                        <div class="flex gap-1">
                                            <template x-for="(color, index) in getAllThemes()[currentScheme].colors" :key="index">
                                                <div :style="`background-color: ${color};`"
                                                     class="w-3 h-3"></div>
                                            </template>
                                        </div>
                                        <!-- Chevron -->
                                        <svg class="w-5 h-5 transition-transform duration-200"
                                             :class="themeDropdownOpen ? 'rotate-180' : ''"
                                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                        </svg>
                                    </div>
                                </button>

                                <!-- Dropdown Menu -->
                                <div x-show="themeDropdownOpen"
                                     @click.away="themeDropdownOpen = false"
                                     x-transition:enter="ease-out duration-200"
                                     x-transition:enter-start="-translate-y-2 opacity-0"
                                     x-transition:enter-end="translate-y-0 opacity-100"
                                     x-transition:leave="ease-in duration-150"
                                     x-transition:leave-start="translate-y-0 opacity-100"
                                     x-transition:leave-end="-translate-y-2 opacity-0"
                                     :style="{ 'background-color': backgroundColor, 'border-color': theme.classified.backgroundAlt }"
                                     class="absolute z-10 w-full mt-1 border overflow-hidden">

                                    <!-- Theme Options -->
                                    <template x-for="(scheme, schemeKey) in getAllThemes()" :key="schemeKey">
                                        <button @click="switchScheme(schemeKey); themeDropdownOpen = false"
                                                :class="currentScheme === schemeKey ? 'opacity-100' : 'opacity-70'"
                                                class="w-full flex items-center justify-between px-4 py-3 hover:opacity-100 transition-opacity border-b"
                                                :style="`border-color: ${theme.classified.backgroundAlt};`">
                                            <!-- Theme name (left) -->
                                            <span class="font-light" x-text="scheme.name"></span>

                                            <!-- Color swatches (right) -->
                                            <div class="flex gap-1">
                                                <template x-for="(color, colorIndex) in scheme.colors" :key="colorIndex">
                                                    <div :style="`background-color: ${color};`"
                                                         class="w-3 h-3"></div>
                                                </template>
                                            </div>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Theme Details (Preview + Mapping) -->
                        <div>
                            <!-- Theme Mapping Editor & Preview -->
                            <div class="pt-8 border-t"
                                 :style="`border-color: ${theme.classified.backgroundAlt};`">

                            <!-- Split Layout: Mapping (left) + Preview (right) -->
                            <div class="flex gap-6 items-stretch">
                                <!-- Left: Theme Mapping Table -->
                                <div class="w-1/2">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-light opacity-70">Theme Mapping</h4>

                                <div class="flex gap-2">
                                <!-- Apply Changes Button -->
                                <button @click="applyThemeChanges()"
                                        :style="`border-color: ${theme.classified.backgroundAlt};`"
                                        class="px-4 py-2 text-sm font-light border hover:opacity-70 transition-opacity">
                                    <span x-text="themeApplied ? 'Applied!' : 'Apply'"></span>
                                </button>

                                <!-- Copy to Clipboard Button -->
                                <button @click="copyMappingToClipboard()"
                                        :style="`border-color: ${theme.classified.backgroundAlt};`"
                                        class="px-4 py-2 text-sm font-light border hover:opacity-70 transition-opacity flex items-center gap-2">
                                    <svg x-show="!themeCopied" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                                    </svg>
                                    <svg x-show="themeCopied" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak>
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                    </svg>
                                    <span x-text="themeCopied ? 'Copied!' : 'Copy Theme'"></span>
                                </button>
                                </div>
                            </div>

                            <!-- Mapping Table -->
                            <div class="space-y-2">
                                <template x-for="(purpose, index) in getMappingPurposes()" :key="purpose">
                                    <div class="flex items-center gap-4 py-2"
                                         :style="`border-color: ${theme.classified.backgroundAlt};`"
                                         :class="index > 0 ? 'border-t' : ''">
                                        <!-- Purpose Label -->
                                        <div class="w-32 text-sm font-light opacity-70" x-text="formatPurposeLabel(purpose)"></div>

                                        <!-- Color Family Dropdown -->
                                        <div x-data="{ open: false, closeTimer: null, openUpward: false }"
                                             @mouseleave="closeTimer = setTimeout(() => open = false, 500)"
                                             @mouseenter="clearTimeout(closeTimer)"
                                             class="relative">
                                            <button @click="open = !open; openUpward = ($el.getBoundingClientRect().bottom + 250 > window.innerHeight)"
                                                    x-ref="colorButton"
                                                    :style="`border-color: ${theme.classified.backgroundAlt};`"
                                                    class="px-3 py-1 text-sm border hover:opacity-70 transition-opacity min-w-32 text-left">
                                                <span x-text="formatColorName(themeMapping[purpose].split('.')[0])"></span>
                                            </button>
                                            <div x-show="open"
                                                 @click.away="open = false"
                                                 :style="{ 'background-color': backgroundColor, 'border-color': theme.classified.backgroundAlt }"
                                                 :class="openUpward ? 'bottom-full mb-1' : 'top-full mt-1'"
                                                 class="absolute z-20 border max-h-60 overflow-y-auto">
                                                <template x-for="familyName in Object.keys(getThemePalette())" :key="familyName">
                                                    <button @click="updateMapping(purpose, familyName, themeMapping[purpose].split('.')[1]); open = false"
                                                            class="block w-full px-3 py-2 text-sm text-left hover:opacity-70 flex items-center justify-between gap-2">
                                                        <span x-text="formatColorName(familyName)"></span>
                                                        <div class="flex gap-0.5">
                                                            <template x-for="shade in ['100', '200', '300', '400', '500', '600', '700', '800', '900']" :key="shade">
                                                                <div :style="`background-color: ${getThemePalette()[familyName][shade]}; border: 1px solid ${theme.classified.backgroundAlt};`"
                                                                     class="w-3 h-3"></div>
                                                            </template>
                                                        </div>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Shade Dropdown -->
                                        <div x-data="{ open: false, closeTimer: null, openUpward: false }"
                                             @mouseleave="closeTimer = setTimeout(() => open = false, 500)"
                                             @mouseenter="clearTimeout(closeTimer)"
                                             class="relative">
                                            <button @click="open = !open; openUpward = ($el.getBoundingClientRect().bottom + 250 > window.innerHeight)"
                                                    :style="`border-color: ${theme.classified.backgroundAlt};`"
                                                    class="px-3 py-1 text-sm border hover:opacity-70 transition-opacity min-w-20 text-left">
                                                <span x-text="themeMapping[purpose].split('.')[1]"></span>
                                            </button>
                                            <div x-show="open"
                                                 @click.away="open = false"
                                                 :style="{ 'background-color': backgroundColor, 'border-color': theme.classified.backgroundAlt }"
                                                 :class="openUpward ? 'bottom-full mb-1' : 'top-full mt-1'"
                                                 class="absolute z-20 border max-h-60 overflow-y-auto">
                                                <template x-for="shade in ['100', '200', '300', '400', '500', '600', '700', '800', '900']" :key="shade">
                                                    <button @click="updateMapping(purpose, themeMapping[purpose].split('.')[0], shade); open = false"
                                                            class="block w-full px-3 py-2 text-sm text-left hover:opacity-70 flex items-center justify-between gap-2">
                                                        <span x-text="shade"></span>
                                                        <div :style="`background-color: ${getThemePalette()[themeMapping[purpose].split('.')[0]][shade]}; border: 1px solid ${theme.classified.backgroundAlt};`"
                                                             class="w-6 h-6"></div>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Color Preview -->
                                        <div :style="`background-color: ${getMappingColor(purpose)}; border: 1px solid ${theme.classified.backgroundAlt};`"
                                             class="w-8 h-8"></div>
                                    </div>
                                </template>
                            </div>
                                </div><!-- End Left: Theme Mapping Table -->

                                <!-- Right: Live Preview -->
                                <div class="w-1/2"
                                     x-data="{
                                         sampleView: 'month',

                                         monthData: {
                                             labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                                             assets: [65, 70, 75, 80, 85, 90],
                                             income: [45, 50, 48, 52, 55, 58],
                                             netWorth: [110, 120, 123, 132, 140, 148],
                                             target: [100, 110, 120, 130, 140, 150]
                                         },

                                         yearData: {
                                             labels: ['2021', '2022', '2023', '2024', '2025', '2026'],
                                             assets: [400, 480, 550, 620, 710, 800],
                                             income: [280, 310, 340, 380, 420, 450],
                                             netWorth: [680, 790, 890, 1000, 1130, 1250],
                                             target: [600, 750, 900, 1050, 1200, 1350]
                                         },

                                         // Preview colors that update as theme mapping changes
                                         previewColors: {
                                             background: '',
                                             backgroundAlt: '',
                                             text: '',
                                             chart1: '',
                                             chart2: '',
                                             chart3: '',
                                             chart4: ''
                                         },

                                         getChartInstance() {
                                             return window._previewChartInstance || null;
                                         },

                                         setChartInstance(chart) {
                                             window._previewChartInstance = chart;
                                         },

                                         // Get color from current theme mapping
                                         getPreviewColor(purpose) {
                                             const path = this.themeMapping[purpose];
                                             if (!path) return '#ff00ff';
                                             const [family, shade] = path.split('.');
                                             const themeObj = THEMES[this.currentScheme];
                                             return themeObj?.palette[family]?.[shade] || '#ff00ff';
                                         },

                                         // Update preview colors from theme mapping
                                         updatePreviewColors() {
                                             this.previewColors.background = this.getPreviewColor('background');
                                             this.previewColors.backgroundAlt = this.getPreviewColor('backgroundAlt');
                                             this.previewColors.text = this.getPreviewColor('text');
                                             this.previewColors.chart1 = this.getPreviewColor('chart1');
                                             this.previewColors.chart2 = this.getPreviewColor('chart2');
                                             this.previewColors.chart3 = this.getPreviewColor('chart3');
                                             this.previewColors.chart4 = this.getPreviewColor('chart4');
                                         },

                                         initPreviewChart() {
                                             setTimeout(() => {
                                                 const ctx = document.getElementById('themePreviewChart');
                                                 if (!ctx) return;

                                                 const data = this.sampleView === 'month' ? this.monthData : this.yearData;

                                                 // Initialize preview colors and store update function for parent to call
                                                 this.updatePreviewColors();
                                                 window._updatePreviewColors = () => this.updatePreviewColors();

                                                 this.setChartInstance(new Chart(ctx, {
                                                     type: 'bar',
                                                     data: {
                                                         labels: data.labels,
                                                         datasets: [
                                                             {
                                                                 type: 'bar',
                                                                 label: 'Assets',
                                                                 data: data.assets,
                                                                 backgroundColor: this.previewColors.chart1
                                                             },
                                                             {
                                                                 type: 'bar',
                                                                 label: 'Income',
                                                                 data: data.income,
                                                                 backgroundColor: this.previewColors.chart2
                                                             },
                                                             {
                                                                 type: 'line',
                                                                 label: 'Net Worth',
                                                                 data: data.netWorth,
                                                                 borderColor: this.previewColors.chart3,
                                                                 backgroundColor: 'transparent',
                                                                 pointBackgroundColor: this.previewColors.chart3,
                                                                 pointBorderColor: this.previewColors.chart3,
                                                                 borderWidth: 2
                                                             },
                                                             {
                                                                 type: 'line',
                                                                 label: 'Target',
                                                                 data: data.target,
                                                                 borderColor: this.previewColors.chart4,
                                                                 backgroundColor: 'transparent',
                                                                 pointBackgroundColor: this.previewColors.chart4,
                                                                 pointBorderColor: this.previewColors.chart4,
                                                                 borderWidth: 2,
                                                                 borderDash: [5, 5]
                                                             }
                                                         ]
                                                     },
                                                     options: {
                                                         responsive: true,
                                                         maintainAspectRatio: false,
                                                         interaction: { mode: 'index', intersect: false },
                                                         scales: {
                                                             x: {
                                                                 grid: { color: this.previewColors.backgroundAlt },
                                                                 ticks: { color: this.previewColors.text }
                                                             },
                                                             y: {
                                                                 grid: { color: this.previewColors.backgroundAlt },
                                                                 ticks: { color: this.previewColors.text }
                                                             }
                                                         },
                                                         plugins: {
                                                             legend: {
                                                                 labels: { color: this.previewColors.text }
                                                             }
                                                         }
                                                     }
                                                 }));
                                             }, 100);
                                         },

                                         updateChartData() {
                                             const chart = this.getChartInstance();
                                             if (!chart) return;

                                             const data = this.sampleView === 'month' ? this.monthData : this.yearData;

                                             // Update chart data
                                             chart.data.labels = data.labels;
                                             chart.data.datasets[0].data = data.assets;
                                             chart.data.datasets[1].data = data.income;
                                             chart.data.datasets[2].data = data.netWorth;
                                             chart.data.datasets[3].data = data.target;

                                             // Update without animation for instant feedback
                                             chart.update('none');
                                         }
                                     }"
                                     x-init="initPreviewChart()">
                                    <h4 class="text-sm font-light opacity-70 mb-4">Live Preview</h4>

                                    <div class="space-y-4 p-4 rounded"
                                         :style="`background-color: ${previewColors.background}; border: 1px solid ${previewColors.backgroundAlt};`">

                                        <!-- Title & Subtitle -->
                                        <div>
                                            <h3 class="text-2xl font-light mb-1"
                                                :style="`color: ${previewColors.text};`">
                                                Sample Dashboard
                                            </h3>
                                            <p class="text-sm font-light opacity-70"
                                               :style="`color: ${previewColors.text};`">
                                                See your theme changes in real-time
                                            </p>
                                        </div>

                                        <!-- Interactive Buttons -->
                                        <div class="flex gap-2">
                                            <button @click="sampleView = 'month'; updateChartData()"
                                                    :style="`color: ${previewColors.text}; border-color: ${previewColors.backgroundAlt}; ${sampleView === 'month' ? 'opacity: 1;' : 'opacity: 0.5;'}`"
                                                    class="px-3 py-1.5 text-sm border hover:opacity-100 transition-opacity">
                                                Month View
                                            </button>
                                            <button @click="sampleView = 'year'; updateChartData()"
                                                    :style="`color: ${previewColors.text}; border-color: ${previewColors.backgroundAlt}; ${sampleView === 'year' ? 'opacity: 1;' : 'opacity: 0.5;'}`"
                                                    class="px-3 py-1.5 text-sm border hover:opacity-100 transition-opacity">
                                                Year View
                                            </button>
                                        </div>

                                        <!-- Sample Text -->
                                        <p class="text-sm leading-relaxed"
                                           :style="`color: ${previewColors.text};`">
                                            This preview demonstrates how your theme appears across different UI elements.
                                            All four chart colors are visible in the graph below.
                                        </p>

                                        <!-- Chart Preview -->
                                        <div style="position: relative; height: 320px; width: 100%;">
                                            <canvas id="themePreviewChart"></canvas>
                                        </div>
                                    </div>
                                </div><!-- End Right: Live Preview -->
                            </div><!-- End Split Layout -->

                            <!-- Theme Colors -->
                            <div class="pt-8 border-t"
                                 :style="`border-color: ${theme.classified.backgroundAlt};`">
                            <h4 class="text-sm font-light mb-3 opacity-70">Theme Colors</h4>

                            <!-- Color Palette Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs">
                                    <thead>
                                        <tr>
                                            <th class="text-left font-light py-2 pr-4 opacity-70">Color</th>
                                            <th class="font-light py-2 px-1 opacity-70">100</th>
                                            <th class="font-light py-2 px-1 opacity-70">200</th>
                                            <th class="font-light py-2 px-1 opacity-70">300</th>
                                            <th class="font-light py-2 px-1 opacity-70">400</th>
                                            <th class="font-light py-2 px-1 opacity-70">500</th>
                                            <th class="font-light py-2 px-1 opacity-70">600</th>
                                            <th class="font-light py-2 px-1 opacity-70">700</th>
                                            <th class="font-light py-2 px-1 opacity-70">800</th>
                                            <th class="font-light py-2 px-1 opacity-70">900</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(colorFamily, familyName) in getThemePalette()" :key="familyName">
                                            <tr :style="`border-color: ${theme.classified.backgroundAlt};`" class="border-t">
                                                <td class="text-left font-light py-2 pr-4 opacity-70" x-text="formatColorName(familyName)"></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['100']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['200']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['300']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['400']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['500']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['600']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['700']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['800']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                                <td class="py-2 px-1 text-center"><div :style="`background-color: ${colorFamily['900']}; border: 1px solid ${theme.classified.backgroundAlt};`" class="w-6 h-6 inline-block"></div></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                                </div><!-- End theme tab -->
                            </div><!-- End tab content -->
                        </div><!-- End tabs container -->
                    </div><!-- End max-w-6xl mx-auto -->
                </div>
            </div>
        </template>

        <!-- Main Content -->
        <div class="flex flex-col items-center min-h-screen px-8 py-16">
            <!-- Header Section -->
            <div class="text-center mb-12">
                <h1 class="text-6xl font-light tracking-wide mb-4"
                    :style="`color: ${textColor};`">
                    AdvancedPF
                </h1>
                <p class="text-xl font-light tracking-wider"
                   :style="`color: ${theme ? theme.classified.textSubtle : textColor};`">
                    personal finance: simple, local.
                </p>
            </div>

            <!-- Charts Section -->
            <div class="w-full max-w-6xl">
                <!-- Net Worth Chart Container -->
                <div class="w-full mb-8">
                    <div class="mb-4">
                        <h2 class="text-4xl font-light mb-1"
                            :style="`color: ${theme ? theme.classified.text : textColor};`">
                            Net Worth
                        </h2>
                        <p class="text-xl font-light"
                           :style="`color: ${theme ? theme.classified.textSubtle : textColor};`">
                            all time
                        </p>
                    </div>

                    <!-- Error Message -->
                    <div x-show="hasError"
                         x-cloak
                         class="p-6 border"
                         :style="`display: ${hasError ? 'block' : 'none'}; border-color: ${theme ? theme.classified.backgroundAlt : '#ccc'}; color: ${textColor};`">
                        <p class="font-light mb-2">⚠️ Failed to load data</p>
                        <p class="text-sm opacity-70" x-text="dataLoadError"></p>
                        <p class="text-sm opacity-70 mt-4">Run: <code class="px-2 py-1" :style="`background-color: ${theme ? theme.classified.backgroundAlt : '#f0f0f0'};`">just serve --generate-sample-data</code></p>
                    </div>

                    <!-- Chart -->
                    <div x-show="!hasError" style="position: relative; height: 400px; width: 100%;">
                        <canvas id="netWorthChart"></canvas>
                    </div>
                </div>

                <!-- Two Charts Side by Side -->
                <div x-show="!hasError" class="w-full grid grid-cols-2 gap-8 mb-8">
                    <!-- Left: 12 Month Net Worth -->
                    <div>
                        <h2 class="text-xl font-light mb-4"
                            :style="`color: ${theme ? theme.classified.textSubtle : textColor};`">
                            last twelve months
                        </h2>
                        <div style="position: relative; height: 400px; width: 100%;">
                            <canvas id="netWorth12MonthsChart"></canvas>
                        </div>
                    </div>

                    <!-- Right: Asset Allocation -->
                    <div>
                        <h2 class="text-xl font-light mb-4"
                            :style="`color: ${theme ? theme.classified.textSubtle : textColor};`">
                            asset allocation
                        </h2>
                        <div style="position: relative; height: 400px; width: 100%;">
                            <canvas id="assetAllocationChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Future charts go here -->
            </div>
        </div>
    </div>

    <!-- Alpine.js x-cloak style -->
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>

    <script>
        function dashboard() {
            return {
                currentScheme: 'pacificMist_dark',
                backgroundColor: '#46494c',
                textColor: '#ffffff',
                theme: null,
                settingsOpen: false,
                verbose: false,
                netWorthData: null,
                netWorth12MonthsData: null,
                assetAllocationData: null,
                dataLoadError: null,
                themeMapping: {},
                themeCopied: false,
                themeApplied: false,

                get hasError() {
                    return this.dataLoadError !== null && this.dataLoadError !== undefined && this.dataLoadError !== '';
                },

                async init() {
                    this.loadTheme();
                    await this.loadData();
                    this.renderCharts();
                },

                loadTheme() {
                    this.theme = getTheme(this.currentScheme);
                    this.backgroundColor = this.theme.classified.background;
                    this.textColor = this.theme.classified.text;

                    // Initialize theme mapping for editing
                    const themeObj = THEMES[this.currentScheme];
                    this.themeMapping = { ...themeObj.mapping };
                },

                async loadData() {
                    try {
                        // Load all CSV files
                        const rawData = await loadAllData();

                        // Create data source objects (matching main.py structure)
                        const cash = new SnapshotData('cash', rawData.cash);
                        const property = new SnapshotData('property', rawData.property);
                        const debt = new SnapshotData('debt', rawData.debt);
                        const securities = new SnapshotData('securities', rawData.securities);
                        const credit = new EventData('credit', rawData.credit);

                        // Combine sources (exclude credit from net worth)
                        const sources = [cash, property, debt, securities];

                        // Find the actual date range from the data
                        const allDates = [
                            ...rawData.cash.map(d => d.date),
                            ...rawData.property.map(d => d.date),
                            ...rawData.debt.map(d => d.date),
                            ...rawData.securities.map(d => d.date)
                        ];

                        if (allDates.length === 0) {
                            throw new Error('No data found in CSV files');
                        }

                        const minDate = new Date(Math.min(...allDates));
                        const maxDate = new Date(Math.max(...allDates));

                        // Calculate months between min and max
                        const monthsDiff = (maxDate.getFullYear() - minDate.getFullYear()) * 12 +
                                          (maxDate.getMonth() - minDate.getMonth()) + 1;

                        // Get data for all months in the actual range
                        const monthSkeleton = createMonthSkeleton(monthsDiff);
                        const monthValues = monthSkeleton.map(month => {
                            let total = 0;
                            sources.forEach(source => {
                                const monthData = source.valueByMonth(monthsDiff);
                                const dataPoint = monthData.find(d => d.month === month);
                                if (dataPoint) {
                                    total += dataPoint.value;
                                }
                            });
                            return { month, value: total };
                        });

                        // Filter to remove leading and trailing zeros, but keep zeros in the middle
                        // Find first and last non-zero values
                        const firstNonZeroIndex = monthValues.findIndex(d => d.value !== 0);
                        const lastNonZeroIndex = monthValues.map(d => d.value !== 0).lastIndexOf(true);

                        if (firstNonZeroIndex === -1) {
                            throw new Error('No non-zero data found');
                        }

                        // Keep data from first to last non-zero value (inclusive)
                        const filteredData = monthValues.slice(firstNonZeroIndex, lastNonZeroIndex + 1);

                        // Compute source breakdowns for verbose mode
                        const sourceBreakdowns = {};
                        filteredData.forEach(monthData => {
                            const month = monthData.month;
                            const breakdown = { cash: 0, property: 0, debt: 0, securities: 0 };

                            sources.forEach(source => {
                                const sourceData = source.valueByMonth(monthsDiff);
                                const dataPoint = sourceData.find(d => d.month === month);
                                if (dataPoint) {
                                    breakdown[source.type] = dataPoint.value;
                                }
                            });

                            sourceBreakdowns[month] = breakdown;
                        });

                        this.netWorthData = {
                            months: filteredData.map(d => d.month),
                            values: filteredData.map(d => d.value),
                            sourceBreakdowns: sourceBreakdowns
                        };

                        // Calculate 12-month net worth with year-over-year comparison
                        this.netWorth12MonthsData = computeValueOverLast12Months(sources);

                        // Calculate asset allocation
                        this.assetAllocationData = computeAssetAllocation(sources, rawData.manifest);

                        this.dataLoadError = null;

                    } catch (error) {
                        console.error('Failed to load data:', error);
                        this.dataLoadError = error.message;
                        this.netWorthData = null;
                    }
                },

                renderCharts() {
                    try {
                        // Only render if data loaded successfully
                        if (this.netWorthData && this.dataLoadError === null) {
                            createAllTimeNetWorthChart(
                                'netWorthChart',
                                this.netWorthData,
                                this.theme.classified,
                                this.verbose,
                                this.netWorthData.sourceBreakdowns
                            );
                        }

                        if (this.netWorth12MonthsData && this.dataLoadError === null) {
                            create12MonthNetWorthChart(
                                'netWorth12MonthsChart',
                                this.netWorth12MonthsData,
                                this.theme.classified
                            );
                        }

                        if (this.assetAllocationData && this.dataLoadError === null) {
                            createAssetAllocationChart(
                                'assetAllocationChart',
                                this.assetAllocationData,
                                this.theme.classified
                            );
                        }
                    } catch (error) {
                        console.error('Error rendering charts:', error);
                    }
                },

                switchScheme(schemeName) {
                    this.currentScheme = schemeName;
                    this.loadTheme();
                    this.renderCharts(); // Re-render charts with new colors
                    this.updatePreviewChartColors(); // Update live preview with new theme
                },

                applyThemeChanges() {
                    // Get current theme and update its classified colors with modified mapping
                    const themeObj = THEMES[this.currentScheme];
                    if (!themeObj) return;

                    // Rebuild classified colors from the modified themeMapping
                    const classified = {};
                    for (const [purpose, path] of Object.entries(this.themeMapping)) {
                        const [colorFamily, shade] = path.split('.');
                        classified[purpose] = themeObj.palette[colorFamily]?.[shade] || '#ff00ff';
                    }

                    // Update theme with new classified colors
                    this.theme.classified = classified;
                    this.backgroundColor = classified.background;
                    this.textColor = classified.text;

                    // Re-render all charts with new colors
                    this.renderCharts();

                    // Show "Applied!" feedback
                    this.themeApplied = true;
                    setTimeout(() => {
                        this.themeApplied = false;
                    }, 2000);
                },

                getAllThemes() {
                    return getAllThemes();
                },

                getThemePalette() {
                    const themeObj = THEMES[this.currentScheme];
                    return themeObj ? themeObj.palette : {};
                },

                formatColorName(name) {
                    return name.replace(/_/g, ' ');
                },

                formatPurposeLabel(purpose) {
                    // Convert camelCase to lowercase with spaces
                    // e.g., backgroundAlt -> background alt
                    // Also handle chartN -> chart N
                    return purpose
                        .replace(/([A-Z])/g, ' $1')
                        .replace(/chart(\d)/g, 'chart $1')
                        .toLowerCase()
                        .trim();
                },

                getMappingPurposes() {
                    return Object.keys(this.themeMapping);
                },

                getMappingColor(purpose) {
                    const path = this.themeMapping[purpose];
                    if (!path) return '#ff00ff';
                    const [family, shade] = path.split('.');
                    const themeObj = THEMES[this.currentScheme];
                    return themeObj?.palette[family]?.[shade] || '#ff00ff';
                },

                updateMapping(purpose, family, shade) {
                    this.themeMapping[purpose] = `${family}.${shade}`;
                    // Update preview chart only (not the whole app theme)
                    this.updatePreviewChartColors();
                },

                updatePreviewChartColors() {
                    const chart = window._previewChartInstance;
                    if (!chart) return;

                    // Get colors from current theme mapping
                    const themeObj = THEMES[this.currentScheme];
                    const getColor = (purpose) => {
                        const path = this.themeMapping[purpose];
                        if (!path) return '#ff00ff';
                        const [family, shade] = path.split('.');
                        return themeObj?.palette[family]?.[shade] || '#ff00ff';
                    };

                    // Update chart dataset colors (bars and lines)
                    chart.data.datasets[0].backgroundColor = getColor('chart1');  // Assets bar
                    chart.data.datasets[1].backgroundColor = getColor('chart2');  // Income bar

                    // Net Worth line
                    chart.data.datasets[2].borderColor = getColor('chart3');
                    chart.data.datasets[2].pointBackgroundColor = getColor('chart3');
                    chart.data.datasets[2].pointBorderColor = getColor('chart3');

                    // Target line
                    chart.data.datasets[3].borderColor = getColor('chart4');
                    chart.data.datasets[3].pointBackgroundColor = getColor('chart4');
                    chart.data.datasets[3].pointBorderColor = getColor('chart4');

                    // Update axis and legend colors
                    const textColor = getColor('text');
                    const gridColor = getColor('backgroundAlt');

                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.plugins.legend.labels.color = textColor;

                    // Trigger preview panel color update via callback
                    if (window._updatePreviewColors) {
                        window._updatePreviewColors();
                    }

                    // Update chart (use default mode to ensure all properties update)
                    chart.update();
                },

                async copyMappingToClipboard() {
                    // Format mapping with proper indentation
                    let output = '        mapping: {\n';
                    const entries = Object.entries(this.themeMapping);
                    entries.forEach(([purpose, path], index) => {
                        const isLast = index === entries.length - 1;
                        output += `            ${purpose}: '${path}'${isLast ? '' : ','}\n`;
                    });
                    output += '        }';

                    try {
                        await navigator.clipboard.writeText(output);
                        this.themeCopied = true;
                        setTimeout(() => {
                            this.themeCopied = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                }
            }
        }
    </script>
</body>
</html>
